<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoDoc Dashboard</title>
<style>
:root {
  --bg: #f5f5f5;
  --bg-card: #ffffff;
  --bg-input: #ffffff;
  --text: #1a1a1a;
  --text-muted: #666666;
  --border: #e0e0e0;
  --primary: #2563eb;
  --primary-hover: #1d4ed8;
  --user-bubble: #2563eb;
  --user-text: #ffffff;
  --ai-bubble: #e5e7eb;
  --ai-text: #1a1a1a;
  --sidebar-bg: #fafafa;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
}

[data-theme="dark"] {
  --bg: #0f172a;
  --bg-card: #1e293b;
  --bg-input: #334155;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #334155;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --user-bubble: #3b82f6;
  --user-text: #ffffff;
  --ai-bubble: #334155;
  --ai-text: #f1f5f9;
  --sidebar-bg: #1e293b;
  --shadow: 0 1px 3px rgba(0,0,0,0.3);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
}

header h1 { font-size: 20px; font-weight: 600; }

#theme-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  max-width: 70%;
  padding: 10px 16px;
  border-radius: 12px;
  line-height: 1.5;
  font-size: 14px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.message.user {
  align-self: flex-end;
  background: var(--user-bubble);
  color: var(--user-text);
  border-bottom-right-radius: 4px;
}

.message.assistant {
  align-self: flex-start;
  background: var(--ai-bubble);
  color: var(--ai-text);
  border-bottom-left-radius: 4px;
}

.message.error {
  align-self: center;
  background: #fee2e2;
  color: #991b1b;
  border-radius: 8px;
  font-size: 13px;
}

[data-theme="dark"] .message.error {
  background: #450a0a;
  color: #fca5a5;
}

.message .facts-badge {
  display: inline-block;
  margin-top: 6px;
  font-size: 11px;
  background: rgba(0,0,0,0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg-card);
  display: flex;
  gap: 8px;
}

.chat-input-area select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px;
  border-radius: 8px;
  font-size: 14px;
}

.chat-input-area input {
  flex: 1;
  padding: 10px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 14px;
  outline: none;
}

.chat-input-area input:focus { border-color: var(--primary); }

.chat-input-area button {
  padding: 10px 20px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.chat-input-area button:hover { background: var(--primary-hover); }

.sidebar {
  width: 300px;
  background: var(--sidebar-bg);
  border-left: 1px solid var(--border);
  padding: 24px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.stat-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  box-shadow: var(--shadow);
}

.stat-card .label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.stat-card .value {
  font-size: 28px;
  font-weight: 700;
}

.recent-section h3 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.recent-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.recent-list li {
  font-size: 13px;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.ws-status {
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ws-status .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ef4444;
}

.ws-status .dot.connected { background: #22c55e; }
</style>
</head>
<body>
<header>
  <h1>AutoDoc Dashboard</h1>
  <div style="display:flex;align-items:center;gap:12px">
    <span class="ws-status"><span class="dot" id="ws-dot"></span><span id="ws-label">Disconnected</span></span>
    <button id="theme-toggle">Toggle Theme</button>
  </div>
</header>
<div class="main">
  <div class="chat-area">
    <div class="messages" id="messages"></div>
    <div class="chat-input-area">
      <select id="msg-type">
        <option value="message">Chat</option>
        <option value="ask">Ask</option>
      </select>
      <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off" />
      <button id="send-btn">Send</button>
    </div>
  </div>
  <div class="sidebar">
    <div class="stat-cards">
      <div class="stat-card"><div class="label">Total Facts</div><div class="value" id="stat-facts">-</div></div>
      <div class="stat-card"><div class="label">Open Questions</div><div class="value" id="stat-questions">-</div></div>
      <div class="stat-card"><div class="label">Sessions</div><div class="value" id="stat-sessions">-</div></div>
    </div>
    <div class="recent-section">
      <h3>Recent Facts</h3>
      <ul class="recent-list" id="recent-facts"></ul>
    </div>
    <div class="recent-section">
      <h3>Recent Questions</h3>
      <ul class="recent-list" id="recent-questions"></ul>
    </div>
  </div>
</div>
<script>
(function() {
  const msgContainer = document.getElementById('messages');
  const msgInput = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const msgType = document.getElementById('msg-type');
  const themeBtn = document.getElementById('theme-toggle');
  const wsDot = document.getElementById('ws-dot');
  const wsLabel = document.getElementById('ws-label');

  let ws = null;
  let sessionId = '';

  // Theme
  const savedTheme = localStorage.getItem('autodoc-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeBtn.addEventListener('click', function() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('autodoc-theme', next);
  });

  function addMessage(text, role, factsExtracted) {
    const div = document.createElement('div');
    div.className = 'message ' + role;
    div.textContent = text;
    if (factsExtracted > 0) {
      const badge = document.createElement('span');
      badge.className = 'facts-badge';
      badge.textContent = factsExtracted + ' fact(s) extracted';
      div.appendChild(document.createElement('br'));
      div.appendChild(badge);
    }
    msgContainer.appendChild(div);
    msgContainer.scrollTop = msgContainer.scrollHeight;
  }

  function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws/chat');
    ws.onopen = function() {
      wsDot.classList.add('connected');
      wsLabel.textContent = 'Connected';
    };
    ws.onclose = function() {
      wsDot.classList.remove('connected');
      wsLabel.textContent = 'Disconnected';
      setTimeout(connectWS, 3000);
    };
    ws.onerror = function() {
      wsDot.classList.remove('connected');
      wsLabel.textContent = 'Error';
    };
    ws.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        if (data.session_id) sessionId = data.session_id;
        if (data.type === 'error') {
          addMessage(data.content, 'error', 0);
        } else {
          addMessage(data.content, 'assistant', data.facts_extracted || 0);
        }
      } catch(err) {
        addMessage('Invalid response from server', 'error', 0);
      }
    };
  }

  function send() {
    const text = msgInput.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
    const msg = { type: msgType.value, session_id: sessionId, content: text };
    ws.send(JSON.stringify(msg));
    addMessage(text, 'user', 0);
    msgInput.value = '';
  }

  sendBtn.addEventListener('click', send);
  msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') send();
  });

  // Load stats and recent activity
  function loadStats() {
    fetch('/api/dashboard/stats')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        document.getElementById('stat-facts').textContent = d.total_facts;
        document.getElementById('stat-questions').textContent = d.open_questions;
        document.getElementById('stat-sessions').textContent = d.total_sessions;
      })
      .catch(function() {});
  }

  function loadRecent() {
    fetch('/api/dashboard/recent')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var factsUl = document.getElementById('recent-facts');
        factsUl.innerHTML = '';
        (d.facts || []).forEach(function(f) {
          var li = document.createElement('li');
          li.textContent = '[' + f.scope + '] ' + f.scope_id + '.' + f.key + ' = ' + f.value;
          li.title = li.textContent;
          factsUl.appendChild(li);
        });
        var questionsUl = document.getElementById('recent-questions');
        questionsUl.innerHTML = '';
        (d.questions || []).forEach(function(q) {
          var li = document.createElement('li');
          li.textContent = q.question;
          li.title = q.question;
          questionsUl.appendChild(li);
        });
      })
      .catch(function() {});
  }

  connectWS();
  loadStats();
  loadRecent();
  setInterval(loadStats, 30000);
  setInterval(loadRecent, 30000);
})();
</script>
</body>
</html>
